---
import 'photoswipe/style.css'
import type { CmsImage } from '@/types/rush'

interface Props {
  images: CmsImage[]
  galleryID: string
}

const { images, galleryID } = Astro.props
---

<div class="pswp-gallery" id={galleryID}>
  <div class="columns-1 sm:columns-2 md:columns-3 lg:columns-4 gap-4 space-y-4">
    {images.map((image, index) => {
       const width = image.width || 1200;
       const height = image.height || 800;
       
       return (
        <a
          href={image.url}
          data-pswp-width={width}
          data-pswp-height={height}
          target="_blank"
          rel="noopener noreferrer"
          class="block break-inside-avoid relative group overflow-hidden rounded-lg shadow-sm hover:shadow-md transition-shadow"
        >
          <img
            src={image.url}
            alt={image.name}
            width={width}
            height={height}
            class="w-full h-auto object-cover transform transition-transform duration-300 group-hover:scale-105"
            loading="lazy"
          />
          <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors pointer-events-none" />
        </a>
      );
    })}
  </div>
</div>

<script>
  import PhotoSwipeLightbox from 'photoswipe/lightbox';

  const updateImageDimensions = (gallery: Element) => {
      const anchors = gallery.querySelectorAll('a');
      anchors.forEach((anchor) => {
          const img = anchor.querySelector('img');
          if (img) {
              const update = () => {
                   if (img.naturalWidth && img.naturalHeight) {
                       anchor.setAttribute('data-pswp-width', img.naturalWidth.toString());
                       anchor.setAttribute('data-pswp-height', img.naturalHeight.toString());
                   }
              };

              if (img.complete) {
                  update();
              } else {
                  img.onload = update;
              }
          }
      });
  };

  const initLightbox = () => {
      const galleries = document.querySelectorAll('.pswp-gallery');
      galleries.forEach((gallery) => {
          updateImageDimensions(gallery);

          if ((gallery as any)._pswpInit) return;
          
          const lightbox = new PhotoSwipeLightbox({
            gallery: gallery as HTMLElement,
            children: 'a',
            pswpModule: () => import('photoswipe')
          });
          lightbox.init();
          (gallery as any)._pswpInit = true;
      });
  };

  document.addEventListener('astro:page-load', initLightbox);

  if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initLightbox);
  } else {
      initLightbox();
  }
</script>

---
import Layout from '@/layouts/layout.astro'
import { rush, getCollectionId } from "@/lib/rush"
import MasonryGallery from '@/components/gallery/masonry-gallery.astro'
import type { CmsEntry, CmsImage } from '@/types/rush'

export async function getStaticPaths() {
    try {
        const collectionId = getCollectionId('/eventos')
        const response = await rush.getEntries(collectionId, { limit: 1000 })
        const items = (response as { data?: CmsEntry[] }).data || []

        return items.map((item) => ({
            params: { slug: item.slug },
            props: { item },
        }))
    } catch (e) {
        console.error('Failed to fetch eventos entries:', e)
        return []
    }
}

const { item } = Astro.props as { item: CmsEntry }

function renderRichText(node: any): string {
    if (!node) return '';
    if (typeof node === 'string') return node;
    if (Array.isArray(node)) return node.map(renderRichText).join('');
    
    switch (node.type) {
        case 'doc':
            return renderRichText(node.content);
        case 'paragraph':
            return `<p class="mb-4 leading-relaxed text-gray-700">${renderRichText(node.content)}</p>`;
        case 'text':
            let text = node.text || '';
            if (node.marks) {
                node.marks.forEach((mark: any) => {
                    if (mark.type === 'bold') text = `<strong class="font-bold text-gray-900">${text}</strong>`;
                    if (mark.type === 'italic') text = `<em class="italic">${text}</em>`;
                    if (mark.type === 'link') text = `<a href="${mark.attrs.href}" class="text-[#009640] hover:underline" target="_blank" rel="noopener noreferrer">${text}</a>`;
                    if (mark.type === 'underline') text = `<u class="underline">${text}</u>`;
                });
            }
            return text;
        case 'heading':
            const level = node.attrs?.level || 2;
            const sizes: Record<number, string> = { 1: 'text-4xl', 2: 'text-3xl', 3: 'text-2xl', 4: 'text-xl' }
            const sizeClass = sizes[level as number] || 'text-lg'
            return `<h${level} class="${sizeClass} font-bold text-[#009640] mt-8 mb-4">${renderRichText(node.content)}</h${level}>`;
        case 'bulletList':
            return `<ul class="list-disc pl-5 mb-4 space-y-2">${renderRichText(node.content)}</ul>`;
        case 'orderedList':
            return `<ol class="list-decimal pl-5 mb-4 space-y-2">${renderRichText(node.content)}</ol>`;
        case 'listItem':
            return `<li class="pl-1">${renderRichText(node.content)}</li>`;
        case 'blockquote':
            return `<blockquote class="border-l-4 border-[#009640] pl-4 italic text-gray-600 my-6">${renderRichText(node.content)}</blockquote>`;
        case 'image':
             return `<img src="${node.attrs.src}" alt="${node.attrs.alt || ''}" class="w-full h-auto rounded-lg my-8" />`;
        default:
            return node.content ? renderRichText(node.content) : '';
    }
}

const description = (item.data?.description ?? item.description ?? item.content) as unknown
const gallery = ((item.data?.images ?? item.images) || []) as CmsImage[]

const eventDate = new Date(item.published_at || item.created_at);
---

<Layout title={item.title}>
    <article class="min-h-screen py-6 md:py-12">
        <div class="container mx-auto px-4 max-w-2xl">

            <a href="/eventos" class="inline-flex items-center text-gray-500 hover:text-[#009640] mb-8 uppercase tracking-wider text-sm font-bold transition-colors group">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 transition-transform group-hover:-translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Voltar para Eventos
            </a>

            <header class="max-w-4xl">
                 <div class="flex items-center gap-2 mb-4">
                    <span class="bg-[#009640]/10 text-[#009640] px-3 py-1 rounded-full text-xs font-bold uppercase tracking-widest">
                        Evento
                    </span>
                    <time datetime={eventDate.toISOString()} class="text-sm font-bold text-gray-400 uppercase tracking-widest">
                        {eventDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}
                    </time>
                 </div>
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-black text-primary leading-tight">
                    {item.title}
                </h1>
            </header>

            <div class="prose prose-lg prose-green max-w-none text-gray-600 leading-relaxed">
                 <Fragment set:html={renderRichText(description)} />
            </div>
        </div>

        {gallery && gallery.length > 0 && (
            <div class="pt-12">
                <div class="container mx-auto px-4 max-w-2xl">
                    <h2 class="text-2xl font-bold text-[#009640] mb-8 uppercase tracking-wide border-b border-primary/10 pb-4">
                        Galeria de Fotos
                    </h2>
                </div>
                <div class="container mx-auto px-4 max-w-5xl">
                    <MasonryGallery 
                        images={gallery} 
                        galleryID={`gallery-${item.slug}`} 
                    />
                </div>
            </div>
        )}
    </article>
</Layout>

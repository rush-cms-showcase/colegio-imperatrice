---
import Layout from '@/layouts/layout.astro'
import Pagination from '@/components/pagination.astro'
import { rush, getCollectionId } from "@/lib/rush"
import { rushConfig } from "../../../rush.config"
import type { CmsEntry } from '@/types/rush'

export async function getStaticPaths({ paginate }: { paginate: Function }) {
    try {
        const collectionId = getCollectionId('/destaques')
        const response = await rush.getEntries(collectionId, { limit: 1000 })
        const items = (response as { data?: CmsEntry[] }).data || []
        return paginate(items, { pageSize: rushConfig.defaults.perPage || 12 })
    } catch (e) {
        console.error('Failed to fetch destaques entries:', e)
        return paginate([], { pageSize: rushConfig.defaults.perPage || 12 })
    }
}

const { page } = Astro.props as { page: { currentPage: number; lastPage: number; data: CmsEntry[]; url: { prev?: string; next?: string } } }
const pageTitle = page.currentPage > 1 ? `Destaques - Página ${page.currentPage}` : 'Destaques'
const pageDescription = page.currentPage > 1 ? `Confira os destaques do Colégio Imperatrice - Página ${page.currentPage} de ${page.lastPage}` : 'Confira os destaques do Colégio Imperatrice'
---

<Layout title={pageTitle} description={pageDescription}>
    <div class="container mx-auto px-4 py-8 md:py-12">
        <h1 class="text-3xl md:text-4xl font-bold text-[#009640] mb-8 uppercase tracking-wide">Destaques</h1>


        {page.data.length === 0 ? (
            <div class="text-center py-20 bg-gray-50 rounded-xl border-dashed border-2 border-gray-200">
                <p class="text-gray-500 text-lg">Nenhum destaque encontrado no momento.</p>
            </div>
        ) : (
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                {page.data.map((item: any) => {
                    const participations = item.list || [];
                    const count = Array.isArray(participations) ? participations.length : 0;

                    const hash = item.slug.split('').reduce((acc: number, char: string) => acc + char.charCodeAt(0), 0);
                    const variant = (hash % 3) + 1;
                    
                    return (
                        <a href={`/destaques/${item.slug}`} class="group relative w-full aspect-[3/4] block overflow-hidden rounded-lg shadow-none hover:shadow-2xl transition-all duration-500 bg-[#009640]">
                            {item.featured_image ? (
                                <div class="absolute inset-0">
                                    <div 
                                        class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110 opacity-40 mix-blend-multiply grayscale group-hover:grayscale-0"
                                        style={`background-image: url('${item.featured_image.url}')`}
                                    />
                                    <div class="absolute inset-0 bg-[#009640]/80 mix-blend-multiply" />
                                </div>
                            ) : (
                                <div class="absolute inset-0 overflow-hidden">
                                    {variant === 1 && (
                                        <svg class="absolute inset-0 w-full h-full opacity-30 text-[#00642a]" viewBox="0 0 400 600" preserveAspectRatio="none">
                                            <path d="M-100 600 L200 600 L-100 300 Z" fill="currentColor" />
                                            <path d="M-50 600 L350 600 L-50 200 Z" fill="currentColor" opacity="0.5" />
                                            <path d="M0 600 L600 0 L600 600 Z" fill="currentColor" opacity="0.3" />
                                        </svg>
                                    )}
                                    {variant === 2 && (
                                        <svg class="absolute inset-0 w-full h-full opacity-30 text-[#00642a]" viewBox="0 0 400 600" preserveAspectRatio="none">
                                            <path d="M0 0 L200 200 L400 0 V100 L200 300 L0 100 Z" fill="currentColor" opacity="0.6"/>
                                            <path d="M0 600 L200 400 L400 600 V500 L200 300 L0 500 Z" fill="currentColor" opacity="0.6"/>
                                        </svg>
                                    )}
                                    {variant === 3 && (
                                        <svg class="absolute inset-0 w-full h-full opacity-30 text-[#00642a]" viewBox="0 0 400 600" preserveAspectRatio="none">
                                            <polygon points="0,0 250,0 0,350" fill="currentColor" />
                                            <polygon points="400,600 150,600 400,250" fill="currentColor" opacity="0.7" />
                                        </svg>
                                    )}
                                </div>
                            )}

                            <div class="absolute inset-0 p-8 flex flex-col items-center justify-center text-center z-10">
                                <span class="text-white/80 text-xs font-bold uppercase tracking-[0.2em] mb-4 border-b border-white/30 pb-2">
                                    Destaque
                                </span>
                                
                                <h2 class="text-white font-black text-3xl md:text-4xl leading-tight mb-6 drop-shadow-sm group-hover:scale-105 transition-transform duration-300">
                                    {item.title}
                                </h2>

                                {count > 0 && (
                                    <div class="inline-flex items-center gap-2 bg-white/10 backdrop-blur-md px-4 py-2 rounded-full border border-white/20">
                                        <span class="text-white font-bold text-sm">
                                            {count} {count === 1 ? 'Conquista' : 'Conquistas'}
                                        </span>
                                    </div>
                                )}

                                <div class="absolute bottom-8 opacity-0 group-hover:opacity-100 transition-opacity duration-300 transform translate-y-4 group-hover:translate-y-0">
                                    <span class="text-white text-sm font-semibold uppercase tracking-wider border-b-2 border-[#fcd34d] pb-1">Ver perfil</span>
                                </div>
                            </div>
                        </a>
                    )
                })}
            </div>
        )}

        <Pagination
            currentPage={page.currentPage}
            lastPage={page.lastPage}
            prevUrl={page.url.prev}
            nextUrl={page.url.next}
        />
    </div>
</Layout>
